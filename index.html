<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PDF DOSYAM</title>
    
    <!-- 1. Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    
    <!-- 2. REKLAM SDK (Interstitial - Tam Ekran) -->
    <script src="https://js.onclckvd.com/in-stream-ad-admanager/tma.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- ASSETS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #F8FAFC;
            --white: #FFFFFF;
            --primary: #6366F1;
            --primary-light: #EEF2FF;
            --text-main: #0F172A;
            --text-sub: #64748B;
            --border: #E2E8F0;
            --radius: 20px;
            --success: #10B981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none;  scrollbar-width: none; }
        
        body { background-color: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        .view { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* TOAST */
        #toast-container { position: fixed; top: 60px; left: 0; width: 100%; z-index: 9999; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .toast {
            background: rgba(30, 41, 59, 0.95); color: white; padding: 12px 24px;
            border-radius: 50px; margin-bottom: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 10px;
            backdrop-filter: blur(8px); animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto; transform-origin: top center;
        }
        .toast.hiding { animation: slideUp 0.4s forwards; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-50px) scale(0.8); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes slideUp { to { opacity: 0; transform: translateY(-50px) scale(0.8); } }

        /* MARQUEE */
        .marquee-container { width: 100%; background: #FEF9C3; color: #854D0E; overflow: hidden; white-space: nowrap; position: relative; padding: 8px 0; margin-bottom: 15px; border-radius: 12px; border: 1px solid #FEF08A; display: flex; align-items: center; }
        .marquee-content { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; font-size: 13px; font-weight: 600; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* UI ELEMENTS */
        .btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 16px; font-weight: 700; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 8px 20px -5px rgba(99, 102, 241, 0.4); transition: transform 0.1s; }
        .btn:active { transform: scale(0.97); }
        .btn-sec { background: #EEF2FF; color: var(--primary); box-shadow: none; }
        .btn-dang { background: #FEF2F2; color: #EF4444; box-shadow: none; }
        .inp, .txtarea { width: 100%; padding: 14px; border-radius: 16px; border: 2px solid var(--border); background: #fff; margin-bottom: 10px; outline: none; font-size: 14px; transition: 0.3s; }
        .inp:focus { border-color: var(--primary); }
        
        /* HEADER */
        .header { padding: 20px; padding-top: 50px; background: var(--bg); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        
        .header-actions { display: none; flex-direction: column; gap: 15px; align-items: center; }
        .header-icon-btn { width: 40px; height: 40px; background: var(--white); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); color: var(--text-main); font-size: 18px; cursor: pointer; transition: 0.2s; }
        .header-icon-btn:active { transform: scale(0.9); background: var(--primary-light); color: var(--primary); }

        /* PDF GRID */
        .pdf-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .pdf-box { background: var(--white); padding: 15px; border-radius: 20px; text-align: center; border: 1px solid var(--border); height: 185px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; transition: 0.2s; }
        .pdf-box:active { border-color: var(--primary); transform: scale(0.98); }
        .pdf-thumb { width: 45px; height: 45px; background: #EEF2FF; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 20px; margin-bottom: 8px; }
        .pdf-title { font-weight: 700; font-size: 13px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.3; margin-bottom: 5px; }
        .pdf-badge { font-size: 10px; background: #F1F5F9; padding: 3px 8px; border-radius: 12px; margin-bottom: 8px; color: var(--text-sub); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 90%; }
        .pdf-info { width: 100%; display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: #94A3B8; border-top: 1px solid #F1F5F9; padding-top: 8px; margin-top: auto; }
        .pdf-info span { display: flex; align-items: center; gap: 3px; }

        /* SIDEBAR */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1500; display: none; backdrop-filter: blur(4px); }
        .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: var(--white); z-index: 1600; transition: 0.3s; padding: 20px; padding-top: 60px; display: flex; flex-direction: column; box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
        .sidebar.open { left: 0; }
        .side-item { padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 5px; cursor: pointer; border: 1px solid transparent; }
        .side-item:active { background: #EEF2FF; color: var(--primary); }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--white); width: 85%; max-width: 350px; border-radius: 24px; padding: 24px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2); animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); margin-bottom: 50px; }
        .modal-box.closing { animation: popDown 0.3s forwards; }
        .modal-overlay.closing { animation: fadeOut 0.3s forwards; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes popDown { from { transform: scale(1); opacity: 1; } to { transform: scale(0.8); opacity: 0; } }
        @keyframes fadeOut { to { opacity: 0; } }

        /* NAV */
        .nav-container { position: fixed; bottom: 35px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 1000; }
        .nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 24px; display: flex; justify-content: space-around; padding: 14px; box-shadow: 0 20px 50px -10px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.6); }
        .nav-item { font-size: 24px; color: #CBD5E1; transition: 0.3s; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 14px; }
        .nav-item.active { color: var(--primary); background: #EEF2FF; }

        /* LIST ITEM */
        .list-item { background: var(--white); padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .notif-item { background: #FEF9C3; color:#854D0E; padding:15px; border-radius:12px; margin-bottom:10px; text-align:left; font-size:14px; border:1px solid #FEF08A; }

    </style>
</head>
<body>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- SIDEBAR -->
    <div class="sidebar-overlay" id="sb-overlay" onclick="toggleSidebar(false)"></div>
    <div class="sidebar" id="sidebar">
        <h3 style="margin-bottom:20px; color:var(--primary);">Kategoriler</h3>
        <div style="flex:1; overflow-y:auto;" id="sb-list"></div>
        <div style="margin-top:20px; text-align:center; font-size:12px; color:var(--text-sub);">v8.5 Clean</div>
    </div>

    <!-- HEADER -->
    <div class="header">
        <div>
            <div style="font-size:12px; color:var(--text-sub);">HoÅŸ Geldin,</div>
            <div style="font-weight:700; font-size:18px;" id="u-name">KullanÄ±cÄ±</div>
        </div>
        
        <div class="header-actions" id="header-actions">
            <div class="header-icon-btn" onclick="toggleSidebar(true)">
                <i class="fa-solid fa-bars-staggered"></i>
            </div>
            <div class="header-icon-btn" onclick="openModal('m-history'); renderHistory();">
                <i class="fa-solid fa-clock-rotate-left"></i>
            </div>
        </div>
    </div>

    <!-- 1. HOME VIEW -->
    <div id="v-home" class="view active">
        <div class="marquee-container">
            <div class="marquee-content" id="home-marquee-text">Duyurular yÃ¼kleniyor...</div>
        </div>

        <div style="background: linear-gradient(135deg, #6366F1, #A855F7); color: white; border-radius: 24px; padding: 24px; margin-bottom: 24px; position: relative; overflow: hidden; box-shadow: 0 15px 30px -10px rgba(99, 102, 241, 0.4);">
            <h3 style="font-size:22px;">SÄ±navlara HazÄ±r MÄ±sÄ±n?</h3>
            <p style="opacity:0.9; margin-top:5px; font-size:14px;">TÃ¼m kaynaklar elinin altÄ±nda.</p>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn" style="background:var(--white); color:var(--primary); width:auto; padding:10px 20px; font-size:13px; flex:1;" onclick="go('pdfs', document.querySelectorAll('.nav-item')[1])">KÃ¼tÃ¼phaneye Git</button>
                <button class="btn" style="background:rgba(255,255,255,0.2); color:white; width:auto; padding:10px 20px; font-size:13px; backdrop-filter:blur(5px); flex:1;" onclick="openModal('m-req-user')">PDF Ä°ste</button>
            </div>
            <i class="fa-solid fa-book-medical" style="position: absolute; right: -20px; bottom: -30px; font-size: 120px; opacity: 0.15; transform: rotate(-15deg);"></i>
        </div>

        <h4 style="margin-bottom:15px;">HÄ±zlÄ± EriÅŸim</h4>
        <div class="cat-grid" id="home-cat-grid" style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px;"></div>
    </div>

    <!-- 2. PDFS VIEW -->
    <div id="v-pdfs" class="view">
        <h2 style="margin-bottom:15px;" id="lib-title">TÃ¼m Kitaplar</h2>
        <input class="inp" placeholder="ðŸ” Kitap veya yazar ara..." id="search" oninput="render()">
        <div id="pdf-list" class="pdf-grid">
            <div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-sub);">YÃ¼kleniyor...</div>
        </div>
    </div>

    <!-- 3. PROFILE VIEW -->
    <div id="v-profile" class="view">
        <div style="text-align:center; margin:30px 0;">
            <div style="width:100px; height:100px; border-radius:50%; background:var(--white); margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:40px; color:var(--primary); box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
                <i class="fa-solid fa-user-astronaut"></i>
            </div>
            <h3>Profil</h3>
            <p style="color:var(--text-sub); font-size:13px;">KiÅŸisel Ä°statistikler</p>
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <div style="flex:1; background:var(--white); padding:15px; border-radius:12px; text-align:center; border:1px solid var(--border);">
                <div style="font-size:20px; font-weight:800; color:var(--primary);" id="my-ad-stat">0</div>
                <div style="font-size:11px; color:var(--text-sub);">Ä°zlenen Reklam</div>
            </div>
        </div>

        <div class="side-item" onclick="openModal('m-req-user')" style="background:var(--white); border:1px solid var(--border); margin-bottom:10px;">
            <i class="fa-solid fa-bullhorn" style="color:var(--primary);"></i> <div>PDF Ä°ste</div>
        </div>
        <div class="side-item" onclick="openModal('m-user-notifs')" style="background:var(--white); border:1px solid var(--border);">
            <i class="fa-solid fa-bell" style="color:#F59E0B;"></i> <div>Duyurular</div>
        </div>
    </div>

    <!-- 4. ADMIN VIEW -->
    <div id="v-admin" class="view">
        <h2 style="margin-bottom:20px; color:var(--primary);">YÃ¶netici Paneli</h2>
        <div style="background:#1E293B; color:white; padding:20px; border-radius:16px; margin-bottom:15px; text-align:center;">
            <div style="font-size:12px; opacity:0.7;">TOPLAM Ä°ZLENEN REKLAM (GLOBAL)</div>
            <div style="font-size:28px; font-weight:800; color:#FACC15;" id="st-ads-total">0</div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
            <div class="pdf-box" style="height:auto; padding:15px;"><span style="font-size:20px; font-weight:800; color:var(--primary);" id="st-users">0</span><span style="font-size:11px; color:var(--text-sub);">KullanÄ±cÄ±</span></div>
            <div class="pdf-box" style="height:auto; padding:15px;"><span style="font-size:20px; font-weight:800; color:var(--primary);" id="st-pdfs">0</span><span style="font-size:11px; color:var(--text-sub);">PDF</span></div>
        </div>
        <div style="display:grid; gap:10px;">
            <button class="btn btn-sec" onclick="openModal('m-pdf')">PDF YÃ¶net (Ekle/Sil)</button>
            <button class="btn btn-sec" onclick="openModal('m-users')">KullanÄ±cÄ±lar</button>
            <button class="btn btn-sec" onclick="openModal('m-reqs')">Ä°stekler</button>
            <button class="btn btn-sec" onclick="openModal('m-add-notif')">Duyuru YÃ¶netimi</button>
        </div>
    </div>

    <!-- MODAL: UNLOCK -->
    <div id="m-unlock" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom:5px;">Ä°ndirme Kilidi</h3>
            <div style="width:100px; height:100px; border-radius:50%; background:conic-gradient(var(--primary) 0deg, #E2E8F0 0deg); display:flex; align-items:center; justify-content:center; margin:20px auto;" id="prog-circle">
                <div style="width:84px; height:84px; background:var(--white); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:24px;" id="prog-txt">0/3</div>
            </div>
            <p style="color:var(--text-sub); font-size:14px; margin-bottom:20px;">Kalan Reklam: <b style="color:var(--primary);" id="req-ads-count">3</b></p>
            <button class="btn" id="btn-ad" onclick="playClick(); watchAdSequence()">ReklamÄ± BaÅŸlat</button>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="closeM()">VazgeÃ§</button>
        </div>
    </div>

    <!-- MODAL: HISTORY -->
    <div id="m-history" class="modal-overlay">
        <div class="modal-box">
            <h3>Ä°ndirme GeÃ§miÅŸi</h3>
            <div id="history-list" style="max-height:300px; overflow-y:auto; text-align:left; margin:15px 0;"></div>
            <button class="btn btn-dang" style="font-size:12px; padding:10px;" onclick="clearHistory()">GeÃ§miÅŸi Temizle</button>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="closeM()">Kapat</button>
        </div>
    </div>

    <!-- MODAL: USER NOTIFICATIONS -->
    <div id="m-user-notifs" class="modal-overlay">
        <div class="modal-box" style="max-height:80vh; overflow:hidden; display:flex; flex-direction:column;">
            <h3 style="margin-bottom:15px;">Duyurular</h3>
            <div id="user-notif-list" style="overflow-y:auto; flex:1; text-align:left;">
                <div style="text-align:center; color:#CBD5E1;">YÃ¼kleniyor...</div>
            </div>
            <button class="btn btn-sec" style="margin-top:15px;" onclick="closeM()">Kapat</button>
        </div>
    </div>

    <!-- ADMIN MODALS -->
    <div id="m-pdf" class="modal-overlay">
        <div class="modal-box">
            <h3>PDF YÃ¶netimi</h3>
            <div style="background:#F1F5F9; padding:10px; border-radius:12px; margin-bottom:15px;">
                <h5 style="margin-bottom:5px;">Yeni Ekle</h5>
                <input id="ap-l" class="inp" style="font-size:12px;" placeholder="Link (Otomatik DÃ¼zeltme)" oninput="autoDetect(this.value)">
                <input id="ap-n" class="inp" style="font-size:12px;" placeholder="Kitap AdÄ±">
                <input id="ap-c" class="inp" style="font-size:12px;" placeholder="Kategoriler (Otomatik)">
                <input id="ap-ads" class="inp" style="font-size:12px;" type="number" placeholder="Reklam SayÄ±sÄ±">
                <button class="btn" style="padding:10px;" onclick="addPdf()">Ekle</button>
            </div>
            <input class="inp" placeholder="Ara..." oninput="renderAdmPdfs(this.value)">
            <div id="adm-pdf-list" style="max-height:150px; overflow-y:auto; text-align:left;"></div>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="closeM()">Kapat</button>
        </div>
    </div>
    
    <div id="m-users" class="modal-overlay"><div class="modal-box"><h3>KullanÄ±cÄ±lar</h3><input class="inp" placeholder="Ä°sim ara..." oninput="renderUsers(this.value)"><div id="adm-user-list" style="max-height:300px; overflow-y:auto; text-align:left; margin-top:10px;"></div><button class="btn btn-sec" style="margin-top:10px;" onclick="closeM()">Kapat</button></div></div>
    <div id="m-reqs" class="modal-overlay"><div class="modal-box"><h3>Ä°stekler</h3><div id="adm-req-list" style="max-height:300px; overflow-y:auto; text-align:left; margin-top:10px;"></div><button class="btn btn-sec" style="margin-top:10px;" onclick="closeM()">Kapat</button></div></div>
    
    <div id="m-add-notif" class="modal-overlay">
        <div class="modal-box">
            <h3>Duyuru YÃ¶netimi</h3>
            <textarea id="notif-txt" class="txtarea" placeholder="Yeni duyuru yaz..."></textarea>
            <button class="btn" onclick="sendNotification()">YayÄ±nla</button>
            <div style="margin:15px 0; border-top:1px solid var(--border); padding-top:10px; text-align:left;">
                <h5 style="margin-bottom:10px; color:var(--text-sub);">Aktif Duyurular (Silmek iÃ§in tÄ±kla)</h5>
                <div id="adm-notif-list" style="max-height:150px; overflow-y:auto;"></div>
            </div>
            <button class="btn btn-sec" style="margin-top:5px;" onclick="closeM()">Kapat</button>
        </div>
    </div>
    
    <div id="m-req-user" class="modal-overlay"><div class="modal-box"><h3>PDF Ä°ste</h3><input id="req-txt" class="inp" placeholder="PDF AdÄ±"><button class="btn" onclick="sendReq()">GÃ¶nder</button><button class="btn btn-sec" style="margin-top:10px;" onclick="closeM()">Ä°ptal</button></div></div>

    <!-- BOTTOM NAV -->
    <div class="nav-container">
        <div class="nav">
            <div class="nav-item active" onclick="go('home',this)"><i class="fa-solid fa-house"></i></div>
            <div class="nav-item" onclick="go('pdfs',this)"><i class="fa-solid fa-book-open"></i></div>
            <div class="nav-item" onclick="go('profile',this)"><i class="fa-solid fa-user"></i></div>
            <div class="nav-item" id="nav-admin" style="display:none;" onclick="go('admin',this); loadStats();"><i class="fa-solid fa-shield-halved" style="color:var(--primary);"></i></div>
        </div>
    </div>

    <script>
        // CONFIG
        const CFG = {
            apiKey: "AIzaSyDxxxxxxxxx", 
            authDomain: "proje.firebaseapp.com",
            databaseURL: "https://proje-default-rtdb.firebaseio.com",
            projectId: "proje",
            storageBucket: "proje.appspot.com",
            messagingSenderId: "123",
            appId: "1:123:web:abc"
        };
        const ADMIN_IDS = [7904032877, 8392479231];
        const CATS = [
            {n:"Matematik", i:"fa-calculator"}, {n:"Geometri", i:"fa-shapes"}, {n:"Fizik", i:"fa-atom"}, 
            {n:"Kimya", i:"fa-flask"}, {n:"Biyoloji", i:"fa-dna"}, {n:"TÃ¼rkÃ§e", i:"fa-book"}, 
            {n:"Edebiyat", i:"fa-feather"}, {n:"Tarih", i:"fa-landmark"}, {n:"CoÄŸrafya", i:"fa-earth-americas"},
            {n:"Felsefe", i:"fa-brain"}, {n:"Din", i:"fa-mosque"}, {n:"Ä°ngilizce", i:"fa-language"},
            {n:"TYT", i:"fa-check"}, {n:"AYT", i:"fa-list-check"}
        ];

        // --- SES ---
        const realClick = new Audio("https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3");
        function playClick() { realClick.currentTime = 0; realClick.volume = 0.4; realClick.play().catch(() => {}); }

        // --- INTERSTITIAL REKLAM INIT ---
        window.showAdFn = null;
        document.addEventListener('DOMContentLoaded', () => {
            showToast("Uygulama HazÄ±r!");
            if(window.initCdTma) {
                window.initCdTma({ id: 6103736 }).then(show => { window.showAdFn = show; console.log("Int. Reklam Servisi Aktif"); }).catch(e => { console.error("Reklam BaÅŸlatma HatasÄ±:", e); });
            } else { console.log("Reklam Scripti YÃ¼klenemedi"); }
            
            document.querySelectorAll('button, .btn, .nav-item, .side-item, .cat-item, .header-icon-btn').forEach(el => { el.addEventListener('click', playClick); });
        });

        firebase.initializeApp(CFG);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        tg.expand();

        let user = tg.initDataUnsafe.user || {id: 7904032877, first_name: "Admin", last_name: "Test"};
        let pdfs=[], selPdf=null, globalReqAds=3, currentAdStep=0;

        window.onload = () => {
            document.getElementById('u-name').innerText = user.first_name;
            if(ADMIN_IDS.includes(user.id)) document.getElementById('nav-admin').style.display = 'flex';

            db.collection("users").doc(String(user.id)).set({ name: user.first_name, last: Date.now() }, {merge: true});
            db.collection("users").doc(String(user.id)).onSnapshot(doc => { if(doc.exists) document.getElementById('my-ad-stat').innerText = doc.data().adCount || 0; });
            db.collection("settings").doc("config").onSnapshot(doc => { if(doc.exists()) globalReqAds = doc.data().reqAds || 3; });
            db.collection("pdfs").orderBy("name").onSnapshot(snap => { pdfs=[]; snap.forEach(doc => pdfs.push({k:doc.id, ...doc.data()})); renderPdfs('all'); });

            // DUYURU MARQUEE
            db.collection("notifications").orderBy("date", "desc").limit(1).onSnapshot(snap => {
                const marquee = document.getElementById('home-marquee-text');
                if(!snap.empty) {
                    let note = snap.docs[0].data().text;
                    marquee.innerText = "ðŸ“¢ " + note + " ðŸ“¢ " + note + " ðŸ“¢ " + note;
                } else {
                    marquee.innerText = "Åžu an aktif duyuru bulunmamaktadÄ±r.";
                }
            });

            let ch=''; 
            CATS.forEach(c => {
                let html = `<div class="side-item" onclick="filter('${c.n}')"><i class="fa-solid ${c.i}"></i> ${c.n}</div>`;
                document.getElementById('sb-list').innerHTML += html;
                if(document.getElementById('home-cat-grid').children.length < 6) {
                    document.getElementById('home-cat-grid').innerHTML += `<div class="cat-item" onclick="filter('${c.n}')"><div class="cat-icon"><i class="fa-solid ${c.i}"></i></div><div style="font-weight:600; font-size:14px;">${c.n}</div></div>`;
                }
            });
            showToast("Veriler gÃ¼ncellendi.");
        };

        function go(viewId, el) {
            playClick(); 
            document.querySelectorAll('.view').forEach(x=>x.classList.remove('active')); 
            document.getElementById('v-'+viewId).classList.add('active'); 
            
            const headerActions = document.getElementById('header-actions');
            if(viewId === 'pdfs') { headerActions.style.display = 'flex'; } else { headerActions.style.display = 'none'; }
            if(el) { document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); el.classList.add('active'); } 
            showToast(viewId === 'home' ? 'Ana Sayfa' : viewId === 'pdfs' ? 'KÃ¼tÃ¼phane' : viewId === 'profile' ? 'Profil' : 'YÃ¶netici Paneli');
        }

        function toggleSidebar(o) {
            playClick(); if(o) { document.getElementById('sidebar').classList.add('open'); document.getElementById('sb-overlay').style.display='block'; showToast('MenÃ¼ aÃ§Ä±ldÄ±'); } else { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sb-overlay').style.display='none'; }
        }

        function showToast(msg, type='success') {
            const t = document.createElement('div'); t.className = 'toast'; t.innerHTML = `<i class="fa-solid ${type==='success'?'fa-check-circle':'fa-circle-exclamation'}" style="color:${type==='success'?'#10B981':'#EF4444'}"></i> ${msg}`; document.getElementById('toast-container').appendChild(t); setTimeout(() => { t.classList.add('hiding'); setTimeout(()=>t.remove(), 400); }, 3000);
        }

        function filter(c) {
            playClick(); toggleSidebar(false); 
            document.getElementById('lib-title').innerText = (c === 'all' || c === 'TÃ¼mÃ¼') ? 'TÃ¼m Kitaplar' : c; 
            renderPdfs(c); 
            go('pdfs', document.querySelectorAll('.nav-item')[1]); 
            showToast(c + " kategorisi aÃ§Ä±ldÄ±");
        }
        function getPdfIcon(c) { let f=CATS.find(x=>x.n===c); return f?f.i:'fa-file-pdf'; }

        // --- HELPER: KOPYALAMA ---
        function copyText(text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast("BaÄŸlantÄ± kopyalandÄ±!");
        }

        // --- HELPER: KÄ°LÄ°T KONTROL ---
        function isUnlocked(id) {
            let unlocked = JSON.parse(localStorage.getItem('unlocked_pdfs') || '[]');
            return unlocked.includes(id);
        }
        function setUnlocked(id) {
            let unlocked = JSON.parse(localStorage.getItem('unlocked_pdfs') || '[]');
            if(!unlocked.includes(id)) {
                unlocked.push(id);
                localStorage.setItem('unlocked_pdfs', JSON.stringify(unlocked));
            }
        }

        function renderPdfs(c) {
            let list = document.getElementById('pdf-list'); list.innerHTML = '';
            let q = document.getElementById('search').value.toLowerCase();
            let filtered = pdfs.filter(p => {
                let catMatch = (c === 'all' || c === 'TÃ¼mÃ¼') ? true : p.cat.includes(c);
                let nameMatch = p.name.toLowerCase().includes(q);
                return catMatch && nameMatch;
            });

            if(filtered.length === 0) { list.innerHTML = '<div style="grid-column:1/-1; text-align:center; margin-top:40px; color:#94A3B8;">SonuÃ§ yok.</div>'; return; }
            
            filtered.forEach(p => {
                let firstCat = p.cat.split(',')[0].trim();
                let icon = getPdfIcon(firstCat) || 'fa-file-pdf';
                let dateStr = p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '...';
                let lockIcon = isUnlocked(p.k) ? 'fa-unlock' : 'fa-lock';
                let lockColor = isUnlocked(p.k) ? '#10B981' : '#CBD5E1';

                list.innerHTML += `
                    <div class="pdf-box" onclick="unlockPdf('${p.k}')">
                        <div class="pdf-thumb"><i class="fa-solid ${icon}"></i></div>
                        <div class="pdf-title">${p.name}</div>
                        <div class="pdf-badge">${p.cat}</div>
                        <div class="pdf-info">
                            <span><i class="fa-solid fa-download"></i> ${p.downloads || 0}</span>
                            <span><i class="fa-regular fa-clock"></i> ${dateStr}</span>
                        </div>
                        <i class="fa-solid ${lockIcon}" style="position:absolute; top:10px; right:10px; color:${lockColor};"></i>
                    </div>`;
            });
        }
        function render() { renderPdfs('all'); if(document.getElementById('search').value.length > 2) showToast('Arama yapÄ±lÄ±yor...'); }

        function unlockPdf(k){ 
            playClick(); 
            selPdf = pdfs.find(x=>x.k===k); 
            if(isUnlocked(k)) { currentAdStep = parseInt(selPdf.reqAds || globalReqAds); } else { currentAdStep = 0; }
            if(selPdf.reqAds !== undefined && selPdf.reqAds !== null && selPdf.reqAds !== "") { selPdf.finalReq = parseInt(selPdf.reqAds); } else { selPdf.finalReq = globalReqAds; }
            updateUnlockUI(); 
            openModal('m-unlock'); 
            showToast(selPdf.name + " seÃ§ildi");
        }
        
        function updateUnlockUI(){
            let req = selPdf.finalReq;
            if(isUnlocked(selPdf.k)) currentAdStep = req;
            document.getElementById('req-ads-count').innerText = req - currentAdStep;
            document.getElementById('prog-txt').innerText = `${currentAdStep}/${req}`;
            let deg = (currentAdStep / req) * 360;
            document.getElementById('prog-circle').style.background = `conic-gradient(var(--primary) ${deg}deg, #E2E8F0 ${deg}deg)`;
            let btn = document.getElementById('btn-ad');
            
            if(currentAdStep >= req) { 
                btn.innerHTML = 'LÄ°NKÄ° KOPYALA'; btn.style.background = '#10B981'; 
                btn.onclick = () => { 
                    playClick(); addToHistory(selPdf); setUnlocked(selPdf.k);
                    db.collection("pdfs").doc(selPdf.k).update({ downloads: firebase.firestore.FieldValue.increment(1) });
                    copyText(selPdf.link); closeM(); renderPdfs('all'); 
                }; 
            } else { 
                btn.innerHTML = `Reklam Ä°zle`; btn.style.background = ''; btn.onclick = watchAdSequence; 
            }
        }

        // --- GEÃ‡MÄ°Åž ---
        function addToHistory(pdf) {
            let hist = JSON.parse(localStorage.getItem('pdf_history') || '[]');
            hist = hist.filter(x => x.n !== pdf.name);
            hist.unshift({ n: pdf.name, l: pdf.link, d: Date.now() });
            if(hist.length > 20) hist.pop();
            localStorage.setItem('pdf_history', JSON.stringify(hist));
        }

        function renderHistory() {
            let d = document.getElementById('history-list');
            let hist = JSON.parse(localStorage.getItem('pdf_history') || '[]');
            d.innerHTML = '';
            if(hist.length === 0) { d.innerHTML = '<div style="color:#94A3B8;">HenÃ¼z indirme yok.</div>'; return; }
            hist.forEach(h => {
                d.innerHTML += `<div class="list-item" style="padding:10px; cursor:pointer;" onclick="copyText('${h.l}')"><div><div style="font-weight:600; font-size:13px;">${h.n}</div><div style="font-size:10px; color:#64748B;">${new Date(h.d).toLocaleString('tr-TR')}</div></div><i class="fa-regular fa-copy" style="color:var(--primary);"></i></div>`;
            });
        }

        function clearHistory() {
            playClick();
            if(confirm('GeÃ§miÅŸi silmek istiyor musunuz?')) {
                localStorage.removeItem('pdf_history'); renderHistory(); showToast("GeÃ§miÅŸ temizlendi");
            }
        }

        function watchAdSequence(){
            playClick(); let btn = document.getElementById('btn-ad'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            if(window.showAdFn) { window.showAdFn().then(() => { completeAdStep(); }).catch(e => { console.log("Hata:", e); showToast("Reklam izlenemedi.", "error"); updateUnlockUI(); }); } else { showToast("Reklam servisi hazÄ±r deÄŸil.", "error"); updateUnlockUI(); }
        }

        function completeAdStep() {
            currentAdStep++; db.collection("stats").doc("ads").set({ count: firebase.firestore.FieldValue.increment(1) }, {merge:true}); db.collection("users").doc(String(user.id)).set({ adCount: firebase.firestore.FieldValue.increment(1) }, {merge:true}); showToast("Ä°ÅŸlem tamamlandÄ±, adÄ±m kaydedildi."); updateUnlockUI();
        }

        function renderNotifications() {
            const list = document.getElementById('user-notif-list'); list.innerHTML = '<div style="text-align:center; color:#CBD5E1;">YÃ¼kleniyor...</div>';
            db.collection("notifications").orderBy("date", "desc").limit(10).get().then(snap => {
                list.innerHTML = ''; if(snap.empty) { list.innerHTML = '<div style="text-align:center; color:#94A3B8; margin-top:20px;">HenÃ¼z duyuru yok.</div>'; return; }
                snap.forEach(doc => { let n = doc.data(); let date = new Date(n.date).toLocaleDateString(); list.innerHTML += `<div class="notif-item"><div style="font-weight:700; margin-bottom:5px; font-size:12px; opacity:0.7;">${date}</div>${n.text}</div>`; }); showToast("Duyurular yÃ¼klendi");
            });
        }
        function sendNotification() {
            playClick(); let txt = document.getElementById('notif-txt').value; if(!txt) return;
            db.collection("notifications").add({ text: txt, date: Date.now(), by: user.first_name }).then(() => { showToast("Duyuru yayÄ±nlandÄ±!"); document.getElementById('notif-txt').value = ''; renderAdmNotifs(); });
        }

        function loadStats() {
            db.collection("users").get().then(s => document.getElementById('st-users').innerText = s.size);
            document.getElementById('st-pdfs').innerText = pdfs.length;
            db.collection("stats").doc("ads").onSnapshot(doc => { if(doc.exists) document.getElementById('st-ads-total').innerText = doc.data().count || 0; });
            showToast("Ä°statistikler gÃ¼ncellendi");
        }

        function autoDetect(url) {
            let filename = ""; try { filename = decodeURIComponent(url.split('?')[0].split('/').pop()); } catch(e){ return; }
            let raw = filename.replace(/\.pdf$/i, '').replace(/_/g, ' ').replace(/-/g, ' ');
            const corrections = [
                { p: /t[uÃ¼\-_]*rk[cÃ§\-_]*e?/i, r: "TÃ¼rkÃ§e" }, { p: /trk[cÃ§\-_]*e?/i, r: "TÃ¼rkÃ§e" }, { p: /mat[e]*mat[i]*k/i, r: "Matematik" },
                { p: /geo[metri]*/i, r: "Geometri" }, { p: /fiz[ik]*/i, r: "Fizik" },
                { p: /kim[ya]*/i, r: "Kimya" }, { p: /biy[oloja]*/i, r: "Biyoloji" }, { p: /bio/i, r: "Biyoloji" },
                { p: /edeb[iyat]*/i, r: "Edebiyat" }, { p: /tar[ih]*/i, r: "Tarih" },
                { p: /cog[rafy]*/i, r: "CoÄŸrafya" }, { p: /co[gÄŸ\-_]*raf[ya]*/i, r: "CoÄŸrafya" },
                { p: /fel[sefa]*/i, r: "Felsefe" }, { p: /din/i, r: "Din" },
                { p: /ing[ilizce]*/i, r: "Ä°ngilizce" }, { p: /yay[iÄ±\-_]*n[l]*[a]*[r]*[iÄ±\-_]*/i, r: "YayÄ±nlarÄ±" },
                { p: /bank[asiÄ±\-_]*/i, r: "BankasÄ±" }, { p: /sor[u]*/i, r: "Soru" },
                { p: /kon[u]*/i, r: "Konu" }, { p: /anlat[iÄ±]m/i, r: "AnlatÄ±m" },
                { p: /fas[ikÃ¼l]*/i, r: "FasikÃ¼l" }, { p: /den[eme]*/i, r: "Deneme" },
                { p: /par[agraf]*/i, r: "Paragraf" }, { p: /prob[lem]*/i, r: "Problemler" },
                { p: /yildizlar/i, r: "YÄ±ldÄ±zlar" }, { p: /ligi/i, r: "Ligi" },
                { p: /ayd[iÄ±\-_]*n/i, r: "AydÄ±n" }, { p: /h[iÄ±\-_]*z/i, r: "HÄ±z" }, { p: /eis/i, r: "Eis" }
            ];
            let words = raw.split(' ');
            let correctedWords = words.map(w => {
                if(!w) return "";
                for(let c of corrections) { if(c.p.test(w)) return c.r; }
                return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase();
            });
            let cleanName = correctedWords.filter(w => w.length > 0).join(' ');
            let detectedCats = [];
            if(/tyt/i.test(cleanName)) detectedCats.push("TYT");
            if(/ayt/i.test(cleanName)) detectedCats.push("AYT");
            CATS.forEach(c => { if(c.n !== "TYT" && c.n !== "AYT") { if(cleanName.includes(c.n)) detectedCats.push(c.n); } });
            if(cleanName.includes("CoÄŸrafya") && !detectedCats.includes("CoÄŸrafya")) detectedCats.push("CoÄŸrafya");
            if(detectedCats.length === 0) detectedCats.push("DiÄŸer");
            document.getElementById('ap-n').value = cleanName;
            document.getElementById('ap-c').value = detectedCats.join(', ');
            showToast("Otomatik dÃ¼zeltme uygulandÄ±.");
        }
        
        function openModal(id){
            playClick();
            document.querySelectorAll('.modal-overlay').forEach(x => { x.style.display='none'; x.classList.remove('closing'); });
            document.getElementById(id).style.display='flex';
            if(id==='m-reqs') renderRequests(); if(id==='m-pdf') renderAdmPdfs(''); if(id==='m-users') renderUsers(''); if(id==='m-user-notifs') renderNotifications(); 
            if(id==='m-req-user') showToast("Ä°stek formu aÃ§Ä±ldÄ±");
            if(id==='m-add-notif') renderAdmNotifs();
        }

        function closeM(){ 
            playClick();
            const visibleModals = document.querySelectorAll('.modal-overlay[style*="flex"]');
            visibleModals.forEach(modal => {
                modal.classList.add('closing');
                const box = modal.querySelector('.modal-box'); if(box) box.classList.add('closing');
                setTimeout(() => { modal.style.display = 'none'; modal.classList.remove('closing'); if(box) box.classList.remove('closing'); }, 280);
            });
            showToast("Pencere kapatÄ±ldÄ±"); 
        }
        
        function renderRequests(){ let d=document.getElementById('adm-req-list'); d.innerHTML=''; db.collection("requests").get().then(snap => { if(snap.empty) d.innerHTML='Yok.'; snap.forEach(doc => { let r=doc.data(); d.innerHTML+=`<div class="list-item"><div><b>${r.book}</b><br><small>${r.name}</small></div><button class="btn btn-dang" style="width:auto; padding:8px; font-size:12px;" onclick="delReq('${doc.id}')">Sil</button></div>`; }); showToast("Ä°stekler listelendi"); }); }
        function delReq(k){ playClick(); db.collection("requests").doc(k).delete().then(()=>{ renderRequests(); showToast("Ä°stek silindi", "error"); }); }
        
        function addPdf(){ 
            playClick();
            let adVal = document.getElementById('ap-ads').value; let adCount = (adVal === "") ? null : Number(adVal);
            db.collection("pdfs").add({ 
                name:document.getElementById('ap-n').value, 
                link:document.getElementById('ap-l').value, 
                cat:document.getElementById('ap-c').value, 
                reqAds: adCount,
                date: Date.now(), 
                downloads: 0      
            }); 
            showToast('PDF BaÅŸarÄ±yla Eklendi!'); document.getElementById('ap-l').value = ''; document.getElementById('ap-n').value = ''; document.getElementById('ap-ads').value = ''; renderAdmPdfs(''); 
        }
        function renderAdmPdfs(q){ let d=document.getElementById('adm-pdf-list'); d.innerHTML=''; pdfs.forEach(p=>{ if(p.name.toLowerCase().includes(q)) d.innerHTML+=`<div class="list-item"><span>${p.name} <span style="font-size:10px; color:#aaa;">(Reklam: ${p.reqAds || 'Genel'})</span></span> <button class="btn btn-dang" style="width:auto; padding:5px 10px; font-size:12px;" onclick="delPdf('${p.k}')">Sil</button></div>`; }); }
        function delPdf(k){ playClick(); if(confirm('Emin misin?')) { db.collection("pdfs").doc(k).delete().then(() => { showToast("PDF Silindi", "error"); renderAdmPdfs(''); }); } }
        
        function renderUsers(q) {
            let d = document.getElementById('adm-user-list'); d.innerHTML = 'YÃ¼kleniyor...';
            db.collection("users").get().then(snap => {
                d.innerHTML = ''; let count = 0;
                snap.forEach(doc => {
                    let u = doc.data(); let name = u.name || "Ä°simsiz";
                    if(q === '' || name.toLowerCase().includes(q.toLowerCase())) {
                        d.innerHTML += `<div class="list-item"><div><b>${name}</b><br><span style="font-size:10px; color:#64748B;">ID: ${doc.id} | Reklam: ${u.adCount || 0}</span></div><div style="font-size:10px;">${new Date(u.last).toLocaleDateString()}</div></div>`; count++;
                    }
                });
                if(count === 0) d.innerHTML = '<div style="padding:10px; color:#94A3B8;">BulunamadÄ±.</div>';
                if(q.length > 2) showToast("KullanÄ±cÄ±lar filtrelendi");
            });
        }
        function sendReq(){ playClick(); let t=document.getElementById('req-txt').value; if(t){ db.collection("requests").add({book:t, name:user.first_name}); showToast('Ä°stek GÃ¶nderildi'); closeM(); } else { showToast("LÃ¼tfen PDF adÄ± yazÄ±n", "error"); } }

        function renderAdmNotifs() {
            let d = document.getElementById('adm-notif-list');
            d.innerHTML = 'YÃ¼kleniyor...';
            db.collection("notifications").orderBy("date", "desc").get().then(snap => {
                d.innerHTML = '';
                if(snap.empty) { d.innerHTML = '<div style="font-size:12px; color:#94A3B8;">Duyuru yok.</div>'; return; }
                snap.forEach(doc => {
                    let n = doc.data();
                    let date = new Date(n.date).toLocaleDateString();
                    d.innerHTML += `<div class="list-item" style="padding:10px; font-size:12px;"><div style="flex:1; margin-right:10px;"><div style="font-weight:700; color:var(--text-sub);">${date}</div><div>${n.text}</div></div><i class="fa-solid fa-trash" style="color:#EF4444; cursor:pointer; padding:5px;" onclick="delNotif('${doc.id}')"></i></div>`;
                });
            });
        }

        function delNotif(k) {
            playClick();
            if(confirm('Bu duyuruyu silmek istediÄŸine emin misin?')) {
                db.collection("notifications").doc(k).delete().then(() => { showToast("Duyuru silindi"); renderAdmNotifs(); });
            }
        }
    </script>
</body>
</html>
